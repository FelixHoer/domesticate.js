<html>
<head>

  <title>Viewer-Demo</title>
  <script language="javascript" type="text/javascript" src="underscore.1.1.6-min.js"></script>
  <script language="javascript" type="text/javascript" src="jquery-1.6.2.min.js"></script>
  <script language="javascript" type="text/javascript" src="backbone.0.3.3-min.js"></script>
  <script language="javascript" type="text/javascript" src="viewer.js"></script>
  
  <script language="javascript" type="text/javascript">
  	$(function(){
  		
  		// Models
  		
  		var ShopItem = Backbone.Model.extend({}); 
  		var ShopItemCollection = Backbone.Collection.extend({ model: ShopItem });
  		
  		var items = new ShopItemCollection();
  		
  		items.comparator = function(item){
  			return -item.get('price');
  		};
  		
  		items.bind('change:price', function(){
  			items.sort();
  		});
  		
  		items.add([
  		  {name: 'Computer', price: 400}, 
  		  {name: 'Laptop', price: 700}, 
  		  {name: 'Mouse', price: 10}, 
  		  {name: 'Harddisk', price: 100}, 
  		  {name: 'Software', price: 70}
  		]);

  		// Business Logic ;-)
  		
  		var reducePrices = function(){
				items.forEach(function(item){
					item.set({ price: item.get('price') * 0.9 });
				});
			};
			
			var addItem = function(){
				items.add({ name: 'Chair', price: 120 });
			};
			
			var removeItem = function(){
				var index = parseInt(Math.random() * items.length);
				var item = items.at(index);
				alert('removing ' + item.get('name'));
				items.remove(item);
			};
  		
  		// Util
  		
  		var findPrevContextElement = function(context){
  			var parent = findContainerContext(context);
  			if(!parent)
  				return undefined;
  			
  			var index = _.indexOf(parent.container, context);
  			if(parent.container.length === 1 || index === 0)
  				return findPrevContextElement(parent);
  			
  			for(var i = index-1; i >= 0; i--){
  				var prev = parent.container[i];
    			var el = findLastElement(prev);
    			if(el)
    				return el;
  			}
  			
  			return findPrevContextElement(parent);
  		};
  		
  		var findContainerContext = function(context){
				var proto = Object.getPrototypeOf(context);
				if(!proto || proto.hasOwnProperty('element'))
					return undefined;
				if(proto.hasOwnProperty('container'))
					return proto;
				return findContainerContext(proto);
			};
			
			var findLastElement = function(context){
				if(!context)
					return undefined;
				if(context.hasOwnProperty('element'))
					return context.element;
				if(context.hasOwnProperty('container') && _.isArray(context.container))
					for(var i = context.container.length-1; i >= 0; i--){
						var childContext = context.container[i];
						var el = findLastElement(childContext);
						if(el) 
							return el;
					}
				return undefined;
			};
			
			var findAllElements = function(context){
				return _(context.container).chain()
					.flatten()
					.pluck('element')
					.without(undefined)
					.reduce(function(memo, item){
						return memo.add(item);
					}, $()).value()
			};
			
			var moveContext = function(containerContext, oldIndex, newIndex){
				var container = containerContext.container;
				var context = container[oldIndex];
				
				// remove and insert at new position
				container.splice(oldIndex, 1);
				container.splice(newIndex, 0, context);
				
				// detatch all elements and re-insert them
				var elements = findAllElements(context).detach();
				insertElement(elements, containerContext, newIndex);
			};
			
			var buildAndInsert = function(def, context, index){
				(index !== undefined) || (index = context.container.length);
				
				// execute view with intercepted context
				var newContext = createNewContext(context, { container: [] });
				var view = viewer(def, newContext);

				// insert newContext at right place
				context.container.splice(index, 0, newContext);
				
				insertElement(view, context, index);
			};
			
			var insertElement = function(view, containerContext, index){
				var container = containerContext.container;
				(index !== undefined) || (index = container.length);
				
				// find previous element if available
				var previousElement = undefined;
				if(container)
					for(var i = index-1; !previousElement && i >= 0; i--)
						previousElement = findLastElement(container[i]);
				if(!previousElement)
					previousElement = findPrevContextElement(containerContext);
				
				// insert after previous element or append to parent
				if(previousElement)
					$(previousElement).after(view);
				else
					$(getParentElement(containerContext)).prepend(view);
			};
  		
  		var insertLater = function(time){
  			return [function(){
  				var context = this;
  				window.setTimeout(function(){
  					buildAndInsert('['+time+']', context);
  				}, time);
  			}];
  		};
  		
  		var insertLater2 = function(time, i1, i2, i3){
  			return [function(){
  				var context = this;
  				window.setTimeout(function(){
  					buildAndInsert('['+time+']', context, i1);
  				}, time);
  				window.setTimeout(function(){
  					buildAndInsert('['+(time+100)+']', context, i2);
  				}, time+100);
  				window.setTimeout(function(){
  					buildAndInsert('['+(time+200)+']', context, i3);
  				}, time+200);
  				window.setTimeout(function(){
  					moveContext(context, 1, 0);
  					moveContext(context, 0, 1);
  				}, time+1000);
  			}];
  		};
  		
  		// Template
  		
  		var template = 
  		html.div({id: 'container'}, [
  		  html.h1('Shop'),
  		  html.div([
   		  	
   		  	html.hr,
   		  	
   		  	'Available Items:', 
   		  	html.ul(forEach('items',
   		  		html.li({class: bind('item', 'price', ['item-', out])}, [
 							bind('item', 'name', ['the best ', out, ' of all ', out ,'s']), 
 							' costs ', bind('price'), '&euro;'
 						])
   		  	)),
   		  	
   		  	html.hr,
   		  	
   		  	'Edit Items:', 
   		  	html.form({method: 'post', action: '#'}, [
	   		  	html.ul(forEach('items',
	   		  		html.li([
	   		  		  html.input({type: 'text', value: bind('name')}),
	   		  		  ' costs ',
	   		  		  html.input({type: 'text', value: bind('price')}),
	   		  		  '&euro;'
	 						])
	   		  	)),
	   		  	html.button('Buy!')
   		  	]),
   		  	
   		  	html.hr,
   		  	
   		  	html.button('Reduce Prices Again!', reducePrices),
   		  	html.button('Add Item!', addItem),
   		  	html.button('Remove an Item!', removeItem)
  		  ]),
  		  
  		  html.div([
					insertLater2(1000, 0, 1, 2)
  		  ]),
  		  
  		  html.div([
					insertLater(2000),insertLater(1000),insertLater(3000)
  		  ]),
  		  
  		  html.div([
					[insertLater(2000)],insertLater(1000),insertLater(3000)
  		  ]),
  		  
  		  html.div([
					insertLater(2000),insertLater(901),insertLater(2002),insertLater(1000),[insertLater(2003)]
  		  ]),
  		  
  		  html.div([
					'bla',insertLater(1000)
  		  ])
			]);
  		
  		$('body').append(viewer(template, { items: items }));
  		
  	});
  </script> 
  
</head>
<body>

</body>
</html>